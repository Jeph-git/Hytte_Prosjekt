{% extends 'base.html' %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<!-- FONT AWESOME -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
  .fc-event:hover {
    cursor: pointer;
  }
</style>

<div class="container">
  <div class="row">
    <div class="col-md-10 offset-md-1">
      <form id="customer_form" method="POST" action="{{ url_for('calendar.display_calendar') }}">
        {{ form.hidden_tag() }}
        <div class="form-group mt-3">
          {{ form.customer(class="form-control", id="customer_select") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" role="dialog" aria-labelledby="orderModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderModalLabel">Bestilling detaljer</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Lukk</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <h1>Calendar</h1>
  <div id="calendar" class="container"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let calendarElement = document.getElementById('calendar');
    let events = [
      {% for event in events %}
      {
          "title": "{{ event.title | replace("'", "\\'") }}",
          "start": "{{ event.start }}",
          "end": "{{ event.end }}",
          "userId": "{{ event.userId }}",
          "message": "{{ event.message }}",
          "address": "{{ event.address }}",
          "postnummer": "{{ event.postnummer }}",
          "poststed": "{{ event.poststed }}"
      },
      {% endfor %}
    ];

    let calendar = new FullCalendar.Calendar(calendarElement, {
      events: events,
      eventClick: function(info) {
        let userId = info.event.extendedProps.userId;
        let message = info.event.extendedProps.message;
        let address = info.event.extendedProps.address;
        let postnummer = info.event.extendedProps.postnummer;
        let poststed = info.event.extendedProps.poststed;
        displayOrderModal(userId, message, address, postnummer, poststed);
      },
      dayCellContent: function(info) {
        // Initial emoji placeholder
        let emojiElement = document.createElement('span');
        emojiElement.textContent = '';
        emojiElement.style.fontSize = '15px'; // Set initial size

        let cellContent = info.dayNumberText;

        let wrapperDiv = document.createElement('div');
        wrapperDiv.appendChild(emojiElement);
        wrapperDiv.appendChild(document.createTextNode(cellContent)); 

        return { domNodes: [wrapperDiv] };
      }
    });

    calendar.render();

    function displayOrderModal(userId, message, address, postnummer, poststed) {
      let modalBody = document.querySelector('#orderModal .modal-body');
      modalBody.innerHTML = `
          <p><strong>User ID:</strong> ${userId}</p>
          <p><strong>Message:</strong> ${message}</p>
          <p><strong>Addresse:</strong> ${address}</p>
          <p><strong>Postnummer:</strong> ${postnummer}</p>
          <p><strong>Poststed:</strong> ${poststed}</p>
      `;

      $('#orderModal').modal('show');
    }

    const customerSelect = document.getElementById('customer_select');
    if (customerSelect) {
      customerSelect.addEventListener('change', function() {
          document.getElementById('customer_form').submit();
      });
    }

    // Fetch weather data
    fetchWeatherData();

    function fetchWeatherData() {
      // const apiUrl = 'https://api.met.no/weatherapi/locationforecast/2.0/classic?lat=59.4019&lon=9.9301';
      const apiUrl = 'https://api.met.no/weatherapi/locationforecast/2.0/classic?lat=69.1040&lon=19.5343';
      fetch(apiUrl)
        .then(response => response.text())
        .then(data => {
          let parser = new DOMParser();
          let xmlDoc = parser.parseFromString(data, "application/xml");
          let timeNodes = xmlDoc.getElementsByTagName("time");

          let weatherData = {};

          for (let i = 0; i < timeNodes.length; i++) {
            let timeNode = timeNodes[i];
            let date = timeNode.getAttribute('from').split('T')[0];
            let symbol = timeNode.getElementsByTagName('symbol')[0];
            if (symbol) {
              let code = symbol.getAttribute('code');
              if (!weatherData[date]) {
                weatherData[date] = { sun: 0, snow: 0 };
              }
              if (code.includes('snow')) {
                weatherData[date].snow++;
              } else {
                weatherData[date].sun++;
              }
            }
          }

          updateCalendarWeather(weatherData);
        })
        .catch(error => console.error('Error fetching weather data:', error));
    }

    function updateCalendarWeather(weatherData) {
      let calendarDays = document.querySelectorAll('.fc-daygrid-day');
      calendarDays.forEach(day => {
        let date = day.getAttribute('data-date');
        if (weatherData[date]) {
          let emojiElement = day.querySelector('span');
          if (weatherData[date].snow > 0) {
            emojiElement.textContent = '❄️';
          } else {
            emojiElement.textContent = '☀️';
          }
        }
      });
    }
  });
</script>

{% endblock %}
